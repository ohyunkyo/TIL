{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/DevOps/overriding-jenkins-sh/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Today I Learned"}},"markdownRemark":{"id":"1a4e13e1-e49f-584c-83b0-145b3acb2c28","excerpt":"0. 서론 도커허브의 젠킨스 이미지를 사용하여 젠킨스 서비스가 포함된 컨테이너를 시작했다. 그리고 해당 컨테이너의  쉘을 실행한 뒤, 각 Job…","html":"<h2>0. 서론</h2>\n<p>도커허브의 젠킨스 이미지를 사용하여 젠킨스 서비스가 포함된 컨테이너를 시작했다.<br>\n그리고 해당 컨테이너의 <code class=\"language-text\">bash</code> 쉘을 실행한 뒤, 각 Job 에서 테스트나 빌드를 위해 필요한 모듈 또는 패키지를 설치하여 사용중이였다.<br>\n이때의 변경사항은 컨테이너에 저장되지 않기 때문에 컨테이너를 재시작 하게 된다면 동일한 작업을 다시 반복해서 해야 하는 문제가 있었다.<br>\n이것을 자동화 하기 위해 컨테이너 생성시 내가 작성한 쉘 스크립트를 실행하도록 하는 방법을 찾아봤다.</p>\n<h2>1. command 설정 추가</h2>\n<p><code class=\"language-text\">jenkins/jenkins:lts</code> 이미지에 젠킨스 서비스를 실행하는 명령어가 포함되어 있기 때문에 단순하게 <code class=\"language-text\">command</code> 설정을 추가하여 쉘 스크립트를 실행하기만 하면 내가 생각한 대로 될것 같았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># docker-compose.yml</span>\r\n\r\nversion: '3'\r\n\r\nservices:\r\n    jenkins:\r\n        image: jenkins/jenkins:lts\r\n        container_name: jenkins_cicd\r\n        volumes:\r\n            - /var/run/docker.sock:/var/run/docker.sock\r\n            - /home/ec2-user/jenkins_home:/var/jenkins_home\r\n            - /home/ec2-user/jenkins_container_config/django_test_module.sh:/var/jenkins_home/scripts/django_test_module.sh\r\n        ports:\r\n            - \"80:8080\"\r\n        privileged: true\r\n        user: root\r\n        command: sh -c \"/var/jenkins_home/scripts/django_test_module.sh\"</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># django_test_module.sh</span>\r\n\r\n<span class=\"token function\">apt-get</span> update -y\r\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y\r\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> docker.io -y\r\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> python3 pip -y\r\npip <span class=\"token function\">install</span> <span class=\"token assign-left variable\">django</span><span class=\"token operator\">==</span><span class=\"token number\">3.2</span>.6\r\n\r\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> python3-dev default-libmysqlclient-dev build-essential -y</code></pre></div>\n<h2>2. 문제 발생</h2>\n<p>그러나 내가 생각한대로 작동하지 않았다.<br>\n로그를 확인해 봤을때 스크립트는 잘 실행 되었지만 그 이후 젠킨스 서비스가 실행되지 않고 컨테이너가 종료되었다.</p>\n<p>수행할 프로세스가 없는 이미지의 경우 컨테이너 실행을 완료하면 바로 종료된다고 한다.<br>\n내 예상대로라면 이번에 생성한 컨테이너는 스크립트뿐만 아니라 젠킨스 서비스도 같이 실행하기 때문에 종료되면 안될텐데..<br>\n원인이 무엇일까?</p>\n<h2>3. 원인 파악</h2>\n<p>아래 사진은 도커 공식 문서의 <code class=\"language-text\">docker compose</code> 부분이다. <a href=\"https://docs.docker.com/compose/extends/#adding-and-overriding-configuration\">링크</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/TIL/static/4d67820ba7f17bd1296110335fb841d2/1c3a5/300-command-configuration.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.82278481012659%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABP0lEQVQ4y52Si27CMAxF8///tyFglMcmbdBmfeRlJw13ckCFSRtSiXQUx3Ki6/iq3f6Al9cFqt0em2qLTVVhuVrjrdpisVhitd7g8P6BnDNijIWU0hTHu1hqVNu1qBuNRjc4nmo0WqMWGo26bnCqG3R9jxAIzjlY6xBCuEEEX/aAlEYoKRoGg+A9iAiOGC4wAjFsYBAxmKlclFhqRMl/S1nv0JsBHBPSmBHHcULOl9zvfEx/I7XKBo9je8LgQ1H0LCYwPEUoignfpitt297AeYLnBM9xHhQhbynvA4R8PiPnK+fnUTY46F7DUYSP6aaO5hNYFHLEsa3RDQPMIBO3MJ6e+kMRpcQeLMZknkjpNuE5jGLsYkqmO3vkh9Z4xGSbT/2F3rrS6oVLC7Pw15Y5juidgTEGztiCJy4fPBexzQ/N3/QmT3dN/QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"command-configuration\"\n        title=\"command-configuration\"\n        src=\"/TIL/static/4d67820ba7f17bd1296110335fb841d2/f058b/300-command-configuration.png\"\n        srcset=\"/TIL/static/4d67820ba7f17bd1296110335fb841d2/c26ae/300-command-configuration.png 158w,\n/TIL/static/4d67820ba7f17bd1296110335fb841d2/6bdcf/300-command-configuration.png 315w,\n/TIL/static/4d67820ba7f17bd1296110335fb841d2/f058b/300-command-configuration.png 630w,\n/TIL/static/4d67820ba7f17bd1296110335fb841d2/40601/300-command-configuration.png 945w,\n/TIL/static/4d67820ba7f17bd1296110335fb841d2/1c3a5/300-command-configuration.png 981w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>간략히 요약하자면 내가 <code class=\"language-text\">command</code> 옵션을 설정할 경우 원본의 <code class=\"language-text\">command</code> 옵션을 오버라이딩 한다고 한다.<br>\n그렇기 때문에 나의 스크립트만 실행되고 젠킨스 서비스를 시작하는 명령어는 실행되지 않아 컨테이너가 바로 종료되었던 것이다.</p>\n<p><a href=\"https://stackoverflow.com/questions/63883149/docker-compose-command-doesnt-override-dockerfile-cmd\">출처</a></p>\n<h2>4. 문제 해결</h2>\n<p>나는 이 문제를 해결하기 위해 원본 이미지에서 젠킨스 서비스를 시작하는 부분을 가져와 <code class=\"language-text\">docker-compose.yml</code> 파일에 추가하기로 했다.<br>\n오버라이딩 되어 사라진 명령어를 수동으로 추가하는것이다.</p>\n<blockquote>\n<p>다른 방법으로 해결할 수도 있을것 같다</p>\n</blockquote>\n<p><a href=\"https://hub.docker.com/layers/jenkins/jenkins/jenkins/lts/images/sha256-ec98cb8b367b0f9426f71345efe11e001c901704cea0e61fd91beb37af34ef98?context=explore\">도커허브의 이미지</a> (<code class=\"language-text\">jenkins/jenkins:lts</code>) 레이어에서 아래 사진처럼 원하는 부분을 찾아냈다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 544px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/TIL/static/b4cb9a9cb4a39f500073be3420874137/b3e51/400-0-image-layer-detail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABXUlEQVQoz21SCW7CQAzk/2/rK4qqEkKgyV7eI5lq7GwobZEsfMSz47FPKQlKqWitYV1X/afVWo+Yfs8/4xXbuh19pRTEmHAioEhGEoHzHsviEEIE8yEELM4fee+91pzzeDxmtFoVxIegpF4Ac86IKSHEiBgJmCzewdnEhtZZt4Zt27SvT3kAJskKSgAyZUFZ74CSM0IMWvv960T+ZcgGmn4UE3IpqlevCR9LUWvG6lnv4x+AxsL0Iat5XjRmnR+6XUvvA5wP+xQGGpPg7m0iBWSCAO/nD1yGUf3hOmK43mxkyZjuXxhvE4ZxwnWc8HkZNOYD48Ph7RxQRAww56Imu5bdmCMDsj9Mnn6tTetJCm7uB0PJ1tS3yVHnZdl163mveTK2ulP9CEJ70bBveXF2g9TKNAv6ACXwIarvvLPb403GdCyF0/xZSt8ez8B8i/ty+m3qNSQ7LY6cdykI+A11W1egCJk83QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-layer-detail\"\n        title=\"image-layer-detail\"\n        src=\"/TIL/static/b4cb9a9cb4a39f500073be3420874137/b3e51/400-0-image-layer-detail.png\"\n        srcset=\"/TIL/static/b4cb9a9cb4a39f500073be3420874137/c26ae/400-0-image-layer-detail.png 158w,\n/TIL/static/b4cb9a9cb4a39f500073be3420874137/6bdcf/400-0-image-layer-detail.png 315w,\n/TIL/static/b4cb9a9cb4a39f500073be3420874137/b3e51/400-0-image-layer-detail.png 544w\"\n        sizes=\"(max-width: 544px) 100vw, 544px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/21b4d/400-1-jenkins-sh.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.177215189873415%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABH0lEQVQoz3WRS0sDMRSF58e69oe4aMFHsWKrUCl2LbrRXZ2OWB9LFTelgqCb6Uw7ec0kn2SGaVXaCx85SS4nOUnwmVm+hEMrySxNSdI52hiccyXWWqx1wIp6bx3B1vU32xevYCRxkrLIBEprMiFIkrTUiywr13PL0nyj4SSWTOPMd6K1pq7CWvI8r3RRoLTB5CtD3BpwBC43FEajlMYYU44e7Q38XP9GI9VmfE+QJHPiWYqUqjRZoZFCUggBSoG//X+M+UORCYLyVCmX8eqyPoIxXF7d0Gj3aJ0M2D3uc9A9p3U6YK/Tp3HYo9nu0Tw6Y2e/y/P9E0EVr4rozf2v1m9Y5Ia3l3duwzFR9Mho9EAUVXgdhmPCUcVweMfHZMoP6fARPjBCXmcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jenkins-sh\"\n        title=\"jenkins-sh\"\n        src=\"/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/f058b/400-1-jenkins-sh.png\"\n        srcset=\"/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/c26ae/400-1-jenkins-sh.png 158w,\n/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/6bdcf/400-1-jenkins-sh.png 315w,\n/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/f058b/400-1-jenkins-sh.png 630w,\n/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/40601/400-1-jenkins-sh.png 945w,\n/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/78612/400-1-jenkins-sh.png 1260w,\n/TIL/static/0eb1a2eadb16a21ebf9157c9ac9aa2f7/21b4d/400-1-jenkins-sh.png 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>그리고 <code class=\"language-text\">django_test_module.sh</code> 와 위의 명령어 모두 실행되도록 변경했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># docker-compose.yml</span>\r\n\r\nversion: '3'\r\n\r\nservices:\r\n    jenkins:\r\n        image: jenkins/jenkins:lts\r\n        container_name: jenkins_cicd\r\n        volumes:\r\n            - /var/run/docker.sock:/var/run/docker.sock\r\n            - /home/ec2-user/jenkins_home:/var/jenkins_home\r\n            - /home/ec2-user/jenkins_container_config/django_test_module.sh:/var/jenkins_home/scripts/django_test_module.sh\r\n        ports:\r\n            - \"80:8080\"\r\n        privileged: true\r\n        user: root\r\n        command: sh -c \"/var/jenkins_home/scripts/django_test_module.sh &amp;&amp; /sbin/tini -- /usr/local/bin/jenkins.sh\"</code></pre></div>\n<p><a href=\"https://binux.tistory.com/76\">command 설정에서 여러개의 명령어가 실행되도록 하기</a></p>","frontmatter":{"title":"젠킨스 서비스 컨테이너 생성시 쉘 스크립트 실행되도록 하기","date":"May 23, 2022","description":null}},"previous":{"fields":{"slug":"/DevOps/private-repo-on-jenkins/"},"frontmatter":{"title":"젠킨스에서 비공개 저장소 사용하기"}},"next":{"fields":{"slug":"/DevOps/ci-cd-structure-rearchitect/"},"frontmatter":{"title":"CI/CD 구조 재구축"}}},"pageContext":{"id":"1a4e13e1-e49f-584c-83b0-145b3acb2c28","previousPostId":"aa07b4a3-b18d-5a9c-b3d4-23a8ea58f5ed","nextPostId":"ddae6c85-8cc0-5d79-8419-f86d0a572695"}},
    "staticQueryHashes": ["2841359383","3257411868"]}